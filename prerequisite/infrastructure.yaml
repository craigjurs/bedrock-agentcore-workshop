AWSTemplateFormatVersion: '2010-09-09'
Description: 'CloudFormation template for American Red Cross Chatbot System with DynamoDB tables, SSM parameters, and knowledge base infrastructure'
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Lambda Code Configuration
        Parameters:
          - LambdaS3Bucket
          - LambdaS3Key
          
Parameters:

  LambdaS3Bucket:
    Description: The name of S3 bucket which contains lambda code
    Type: String
    MinLength: 1
  
  LambdaS3Key:
    Description: The S3 object key which contains Red Cross chatbot Lambda function code in zip format
    Type: String
    MinLength: 1
    
  LayerS3Key:
    Type: String
    Description: 'S3 key for the DDGS layer zip file'
    MinLength: 1
    
Resources:

  RuntimeAgentCoreRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - bedrock-agentcore.amazonaws.com
            Action:
              - sts:AssumeRole
      Policies:
        - PolicyName: BedrockAgentPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: ECRImageAccess
                Effect: Allow
                Action:
                  - ecr:BatchGetImage
                  - ecr:GetDownloadUrlForLayer
                Resource:
                  - !Sub arn:aws:ecr:${AWS::Region}:${AWS::AccountId}:repository/bedrock_agentcore-redcross*
              - Effect: Allow
                Action:
                  - logs:DescribeLogStreams
                  - logs:CreateLogGroup
                Resource:
                  - !Sub arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/bedrock-agentcore/runtimes/*
              - Effect: Allow
                Action:
                  - logs:DescribeLogGroups
                Resource:
                  - !Sub arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:*
              - Effect: Allow
                Action:
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource:
                  - !Sub arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/bedrock-agentcore/runtimes/*:log-stream:*
              - Sid: ECRTokenAccess
                Effect: Allow
                Action:
                  - ecr:GetAuthorizationToken
                Resource: "*"
              - Effect: Allow
                Action:
                  - xray:PutTraceSegments
                  - xray:PutTelemetryRecords
                  - xray:GetSamplingRules
                  - xray:GetSamplingTargets
                Resource: "*"
              - Effect: Allow
                Action:
                  - cloudwatch:PutMetricData
                Resource: "*"
                Condition:
                  StringEquals:
                    cloudwatch:namespace: bedrock-agentcore
              - Sid: GetAgentAccessToken
                Effect: Allow
                Action:
                  - bedrock-agentcore:GetWorkloadAccessToken
                  - bedrock-agentcore:GetWorkloadAccessTokenForJWT
                  - bedrock-agentcore:GetWorkloadAccessTokenForUserId
                Resource:
                  - !Sub arn:aws:bedrock-agentcore:${AWS::Region}:${AWS::AccountId}:workload-identity-directory/default
                  - !Sub arn:aws:bedrock-agentcore:${AWS::Region}:${AWS::AccountId}:workload-identity-directory/default/workload-identity/redcross*
              - Sid: ProvisionedThroughputModelInvocation
                Effect: Allow
                Action:
                  - bedrock:InvokeModel
                  - bedrock:InvokeModelWithResponseStream
                Resource:
                  - "arn:aws:bedrock:*::foundation-model/*"
                  - !Sub arn:aws:bedrock:${AWS::Region}:${AWS::AccountId}:*
              - Sid: SSMGetparam
                Effect: Allow
                Action:
                  - ssm:GetParameter
                Resource:
                  - !Sub arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/app/customersupport/*
              - Sid: Identity
                Effect: Allow
                Action:
                  - bedrock-agentcore:GetResourceOauth2Token
                Resource:
                  - !Sub arn:aws:bedrock-agentcore:${AWS::Region}:${AWS::AccountId}:token-vault/default/oauth2credentialprovider/redcross*
                  - !Sub arn:aws:bedrock-agentcore:${AWS::Region}:${AWS::AccountId}:workload-identity-directory/default/workload-identity/redcross*
                  - !Sub arn:aws:bedrock-agentcore:${AWS::Region}:${AWS::AccountId}:workload-identity-directory/default
                  - !Sub arn:aws:bedrock-agentcore:${AWS::Region}:${AWS::AccountId}:token-vault/default
              - Sid: SecretManager
                Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                Resource:
                  - !Sub arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:bedrock-agentcore-identity!default/oauth2/redcross*
              - Sid: AgentCoreMemory
                Effect: Allow
                Action:
                  - bedrock-agentcore:ListMemories
                  - bedrock-agentcore:ListMemoryRecords
                  - bedrock-agentcore:RetrieveMemoryRecords
                  - bedrock-agentcore:GetMemory
                  - bedrock-agentcore:GetMemoryRecord
                  - bedrock-agentcore:CreateEvent
                  - bedrock-agentcore:GetEvent
                Resource:
                  - !Sub arn:aws:bedrock-agentcore:${AWS::Region}:${AWS::AccountId}:memory/redcross*

        
  GatewayAgentCoreRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - bedrock-agentcore.amazonaws.com
            Action:
              - sts:AssumeRole
      Policies:
        - PolicyName: BedrockAgentPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: InvokeFunction
                Effect: Allow
                Action:
                  - lambda:InvokeFunction
                Resource:
                  - !GetAtt CustomerSupportLambda.Arn

  # DynamoDB Table (legacy - not used by Red Cross chatbot, kept for compatibility)
  WarrantyTable:
    Type: AWS::DynamoDB::Table
    Properties:
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: serial_number
          AttributeType: S
        - AttributeName: customer_id
          AttributeType: S
      KeySchema:
        - AttributeName: serial_number
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: customer-index
          KeySchema:
            - AttributeName: customer_id
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      Tags:
        - Key: Application
          Value: RedCrossChatbot
        - Key: CostCenter
          Value: RedCrossChatbot

  # DynamoDB Table for User Profiles (legacy - not used by Red Cross chatbot, kept for compatibility)
  CustomerProfileTable:
    Type: AWS::DynamoDB::Table
    Properties:
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: customer_id
          AttributeType: S
        - AttributeName: email
          AttributeType: S
        - AttributeName: phone
          AttributeType: S
      KeySchema:
        - AttributeName: customer_id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: email-index
          KeySchema:
            - AttributeName: email
              KeyType: HASH
          Projection:
            ProjectionType: ALL
        - IndexName: phone-index
          KeySchema:
            - AttributeName: phone
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      Tags:
        - Key: Application
          Value: RedCrossChatbot
        - Key: CostCenter
          Value: RedCrossChatbot

  # Lambda function to populate synthetic data
  PopulateDataFunction:
    Type: AWS::Lambda::Function
    Properties:
      Runtime: python3.12
      Handler: index.lambda_handler
      Role: !GetAtt PopulateDataRole.Arn
      Timeout: 120
      Code:
        ZipFile: |
          import boto3
          import json
          import urllib.request
          from datetime import datetime, timedelta
          import random
          import uuid
          from decimal import Decimal
          
          def send_response(event, context, status, data=None, reason=None):
              # Minimal drop-in replacement for cfnresponse.send
              responseUrl = event['ResponseURL']
              responseBody = {
                  'Status': status,
                  'Reason': reason or f"See CloudWatch Log Stream: {getattr(context, 'log_stream_name', 'N/A')}",
                  'PhysicalResourceId': getattr(context, 'log_stream_name', 'INLINE_FUNCTION'),
                  'StackId': event['StackId'],
                  'RequestId': event['RequestId'],
                  'LogicalResourceId': event['LogicalResourceId'],
                  'NoEcho': False,
                  'Data': data or {}
              }
              dataBytes = json.dumps(responseBody).encode('utf-8')
              req = urllib.request.Request(responseUrl, data=dataBytes, method='PUT')
              req.add_header('content-type', '')
              req.add_header('content-length', str(len(dataBytes)))
              try:
                  with urllib.request.urlopen(req) as resp:
                      resp.read()
              except Exception as e:
                  print(f"send_response error: {e}")
                  
          def lambda_handler(event, context):
              try:
                  if event['RequestType'] == 'Create':
                      dynamodb = boto3.resource('dynamodb')
                      warranty_table_name = event['ResourceProperties']['WarrantyTableName']
                      customer_table_name = event['ResourceProperties']['CustomerTableName']
                      
                      warranty_table = dynamodb.Table(warranty_table_name)
                      customer_table = dynamodb.Table(customer_table_name)
                      
                      # Customer profile data
                      customer_data = [
                          {
                              'customer_id': 'CUST001',
                              'first_name': 'John',
                              'last_name': 'Smith',
                              'email': 'john.smith@email.com',
                              'phone': '+1-555-0101',
                              'address': {
                                  'street': '123 Main Street',
                                  'city': 'New York',
                                  'state': 'NY',
                                  'zip_code': '10001',
                                  'country': 'USA'
                              },
                              'date_of_birth': '1985-03-15',
                              'registration_date': '2022-11-20',
                              'tier': 'Premium',
                              'communication_preferences': {
                                  'email': True,
                                  'sms': True,
                                  'phone': False
                              },
                              'support_cases_count': 2,
                              'total_purchases': 3,
                              'lifetime_value': 2850.00,
                              'notes': 'VIP customer, prefers email communication'
                          },
                          {
                              'customer_id': 'CUST002',
                              'first_name': 'Sarah',
                              'last_name': 'Johnson',
                              'email': 'sarah.johnson@email.com',
                              'phone': '+1-555-0102',
                              'address': {
                                  'street': '456 Oak Avenue',
                                  'city': 'Los Angeles',
                                  'state': 'CA',
                                  'zip_code': '90210',
                                  'country': 'USA'
                              },
                              'date_of_birth': '1990-07-22',
                              'registration_date': '2023-03-15',
                              'tier': 'Standard',
                              'communication_preferences': {
                                  'email': True,
                                  'sms': False,
                                  'phone': True
                              },
                              'support_cases_count': 1,
                              'total_purchases': 1,
                              'lifetime_value': 1299.99,
                              'notes': 'Tech-savvy customer, quick to resolve issues'
                          },
                          {
                              'customer_id': 'CUST003',
                              'first_name': 'Mike',
                              'last_name': 'Davis',
                              'email': 'mike.davis@email.com',
                              'phone': '+1-555-0103',
                              'address': {
                                  'street': '789 Pine Street',
                                  'city': 'Chicago',
                                  'state': 'IL',
                                  'zip_code': '60601',
                                  'country': 'USA'
                              },
                              'date_of_birth': '1988-12-03',
                              'registration_date': '2023-08-10',
                              'tier': 'Gold',
                              'communication_preferences': {
                                  'email': True,
                                  'sms': True,
                                  'phone': True
                              },
                              'support_cases_count': 0,
                              'total_purchases': 2,
                              'lifetime_value': 549.98,
                              'notes': 'Audio enthusiast, interested in premium products'
                          },
                          {
                              'customer_id': 'CUST004',
                              'first_name': 'Emily',
                              'last_name': 'Brown',
                              'email': 'emily.brown@email.com',
                              'phone': '+1-555-0104',
                              'address': {
                                  'street': '321 Elm Drive',
                                  'city': 'Houston',
                                  'state': 'TX',
                                  'zip_code': '77001',
                                  'country': 'USA'
                              },
                              'date_of_birth': '1992-04-18',
                              'registration_date': '2022-09-05',
                              'tier': 'Standard',
                              'communication_preferences': {
                                  'email': True,
                                  'sms': False,
                                  'phone': False
                              },
                              'support_cases_count': 3,
                              'total_purchases': 1,
                              'lifetime_value': 399.99,
                              'notes': 'Fitness enthusiast, uses wearables frequently'
                          },
                          {
                              'customer_id': 'CUST005',
                              'first_name': 'Robert',
                              'last_name': 'Wilson',
                              'email': 'robert.wilson@email.com',
                              'phone': '+1-555-0105',
                              'address': {
                                  'street': '654 Maple Lane',
                                  'city': 'Phoenix',
                                  'state': 'AZ',
                                  'zip_code': '85001',
                                  'country': 'USA'
                              },
                              'date_of_birth': '1983-09-11',
                              'registration_date': '2023-10-12',
                              'tier': 'Premium',
                              'communication_preferences': {
                                  'email': False,
                                  'sms': True,
                                  'phone': True
                              },
                              'support_cases_count': 1,
                              'total_purchases': 1,
                              'lifetime_value': 699.99,
                              'notes': 'Gaming enthusiast, prefers phone support'
                          }
                      ]
                      
                      # Warranty data with customer_id references
                      warranty_data = [
                          {
                              'serial_number': 'ABC12345678',
                              'customer_id': 'CUST001',
                              'product_name': 'SmartPhone Pro Max 128GB',
                              'purchase_date': '2023-01-15',
                              'warranty_end_date': '2025-01-15',
                              'warranty_type': 'Extended Warranty',
                              'coverage_details': 'Full coverage including accidental damage, water damage, and manufacturer defects',
                              'purchase_price': 1299.99,
                              'store_location': 'New York - 5th Avenue'
                          },
                          {
                              'serial_number': 'DEF98765432',
                              'customer_id': 'CUST002',
                              'product_name': 'Laptop Ultra 15.6"',
                              'purchase_date': '2023-06-20',
                              'warranty_end_date': '2024-06-20',
                              'warranty_type': 'Standard Warranty',
                              'coverage_details': 'Hardware defects and manufacturing issues covered. Software support included',
                              'purchase_price': 1299.99,
                              'store_location': 'Los Angeles - Beverly Hills'
                          },
                          {
                              'serial_number': 'GHI11111111',
                              'customer_id': 'CUST003',
                              'product_name': 'Wireless Headphones Elite',
                              'purchase_date': '2024-02-10',
                              'warranty_end_date': '2026-02-10',
                              'warranty_type': 'Premium Warranty',
                              'coverage_details': 'Comprehensive coverage including battery replacement, driver issues, and cosmetic damage',
                              'purchase_price': 299.99,
                              'store_location': 'Chicago - Michigan Avenue'
                          },
                          {
                              'serial_number': 'JKL22222222',
                              'customer_id': 'CUST004',
                              'product_name': 'Smart Watch Series X',
                              'purchase_date': '2022-12-05',
                              'warranty_end_date': '2023-12-05',
                              'warranty_type': 'Standard Warranty',
                              'coverage_details': 'Hardware and software defects covered. Water resistance guaranteed',
                              'purchase_price': 399.99,
                              'store_location': 'Houston - Galleria'
                          },
                          {
                              'serial_number': 'MNO33333333',
                              'customer_id': 'CUST005',
                              'product_name': 'Gaming Console Pro',
                              'purchase_date': '2023-11-25',
                              'warranty_end_date': '2024-11-25',
                              'warranty_type': 'Gaming Warranty',
                              'coverage_details': 'Controller issues, overheating protection, and hard drive replacement covered',
                              'purchase_price': 699.99,
                              'store_location': 'Phoenix - Scottsdale'
                          },
                          {
                              'serial_number': 'PQR44444444',
                              'customer_id': 'CUST001',
                              'product_name': 'Tablet Air 10.9"',
                              'purchase_date': '2024-03-12',
                              'warranty_end_date': '2025-03-12',
                              'warranty_type': 'Standard Warranty',
                              'coverage_details': 'Screen defects, battery issues, and charging port problems covered',
                              'purchase_price': 599.99,
                              'store_location': 'New York - 5th Avenue'
                          },
                          {
                              'serial_number': 'STU55555555',
                              'customer_id': 'CUST001',
                              'product_name': 'Smart TV 65" OLED',
                              'purchase_date': '2023-08-30',
                              'warranty_end_date': '2025-08-30',
                              'warranty_type': 'Extended Warranty',
                              'coverage_details': 'Panel replacement, smart features, sound system, and remote control covered',
                              'purchase_price': 1999.99,
                              'store_location': 'New York - 5th Avenue'
                          },
                          {
                              'serial_number': 'VWX66666666',
                              'customer_id': 'CUST003',
                              'product_name': 'Bluetooth Speaker Pro',
                              'purchase_date': '2024-01-08',
                              'warranty_end_date': '2026-01-08',
                              'warranty_type': 'Audio Warranty',
                              'coverage_details': 'Driver replacement, battery issues, and waterproofing covered',
                              'purchase_price': 249.99,
                              'store_location': 'Chicago - Michigan Avenue'
                          }
                      ]
                      
                      # Insert customer data
                      with customer_table.batch_writer() as batch:
                          for item in customer_data:
                              item = json.loads(json.dumps(item), parse_float=Decimal)
                              batch.put_item(Item=item)
                      
                      # Insert warranty data
                      with warranty_table.batch_writer() as batch:
                          for item in warranty_data:
                              item = json.loads(json.dumps(item), parse_float=Decimal)
                              batch.put_item(Item=item)
                      
                      print(f"Successfully populated {len(customer_data)} customer profiles")
                      print(f"Successfully populated {len(warranty_data)} warranty records")
                      send_response(event, context, 'SUCCESS', {})
                      
                  else:
                      send_response(event, context, 'SUCCESS', {})
                      
              except Exception as e:
                  print(f"Error: {str(e)}")
                  send_response(event, context, 'FAILED', {}, reason=str(e))
                  
                  # IAM Role for Lambda function
  PopulateDataRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: DynamoDBWritePolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:PutItem
                  - dynamodb:BatchWriteItem
                Resource:
                  - !GetAtt WarrantyTable.Arn
                  - !GetAtt CustomerProfileTable.Arn
        - PolicyName: AllowBasicLogs
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                  - logs:PutDeliverySource
                Resource: arn:aws:logs:*:*:*
  # Custom resource to trigger Lambda function
  PopulateData:
    Type: AWS::CloudFormation::CustomResource
    Properties:
      ServiceToken: !GetAtt PopulateDataFunction.Arn
      WarrantyTableName: !Ref WarrantyTable
      CustomerTableName: !Ref CustomerProfileTable
    DependsOn:
      - WarrantyTable
      - CustomerProfileTable
  
  # Lambda target
  CustomerSupportLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      Path: /service-role/
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
      Policies:
        - PolicyName: CustomerProfileAccessPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: AllowReadCustomerTableNameFromSSM
                Effect: Allow
                Action: ssm:GetParameter
                Resource: !Sub arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter${CustomerProfileTableNameParameter}

              - Sid: AllowReadCustomerProfileTable
                Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:Query
                  - dynamodb:DescribeTable
                Resource: !Sub arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${CustomerProfileTable}

              - Sid: AllowReadCustomerTableIndexes
                Effect: Allow
                Action:
                  - dynamodb:Query
                Resource: !Sub arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${CustomerProfileTable}/index/*

        - PolicyName: WarrantyCheckAccessPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: AllowReadWarrantyTableNameFromSSM
                Effect: Allow
                Action: ssm:GetParameter
                Resource: !Sub arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter${WarrantyTableNameParameter}

              - Sid: AllowReadWarrantyTable
                Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:DescribeTable
                Resource: !Sub arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${WarrantyTable}

        - PolicyName: cloudwatch-logs-access
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Sid: CloudWatchLogReadStatement
                Effect: Allow
                Action:
                  - logs:DescribeLogGroups
                  - logs:GetQueryResults
                  - logs:StartQuery
                Resource: "*"
              - Sid: CloudWatchLogWriteStatement
                Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/bedrock-agentcore/evaluations/*"
              - Sid: CloudWatchIndexPolicyStatement
                Effect: Allow
                Action:
                  - logs:DescribeIndexPolicies
                  - logs:PutIndexPolicy
                Resource:
                  - !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:aws/spans"
                  - !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:aws/spans:*"
              - Sid: BedrockInvokeStatement
                Effect: Allow
                Action:
                  - bedrock:InvokeModel
                  - bedrock:InvokeModelWithResponseStream
                Resource:
                  - "arn:aws:bedrock:*::foundation-model/*"
                  - !Sub "arn:aws:bedrock:*:${AWS::AccountId}:inference-profile/*"

  DDGSLayer:
    Type: AWS::Lambda::LayerVersion
    Properties:
      LayerName: !Sub "${AWS::StackName}-ddgs-layer"
      Description: 'DDGS package for Lambda functions'
      Content:
        S3Bucket: !Ref  LambdaS3Bucket
        S3Key: !Ref LayerS3Key
      CompatibleRuntimes:
        - python3.12
      CompatibleArchitectures:
        - x86_64

  CustomerSupportLambda:
    Type: AWS::Lambda::Function
    Properties:
      Description: 'Lambda function for American Red Cross Chatbot (web search tool)'
      Handler: lambda_function.lambda_handler
      Code:
        S3Bucket: !Ref LambdaS3Bucket
        S3Key: !Ref LambdaS3Key
      Role: !GetAtt CustomerSupportLambdaRole.Arn
      Runtime: python3.12
      PackageType: Zip
      Architectures:
        - x86_64
      Layers:
        - !Ref DDGSLayer
      Environment:
        Variables:
          PYTHONPATH: /opt/python

  
# SSM Parameter to store warranty table name
  WarrantyTableNameParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /app/redcross/dynamodb/warranty_table_name
      Type: String
      Value: !Ref WarrantyTable
      Description: DynamoDB table name for warranty information
      Tags:
        Application: CustomerSupport

  # SSM Parameter to store customer profile table name
  CustomerProfileTableNameParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /app/redcross/dynamodb/customer_profile_table_name
      Type: String
      Value: !Ref CustomerProfileTable
      Description: DynamoDB table name for customer profiles
      Tags:
        Application: CustomerSupport

  GatewayAgentcoreIAMRoleParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /app/redcross/agentcore/gateway_iam_role
      Type: String
      Value: !GetAtt GatewayAgentCoreRole.Arn
      Description: agentcore IAM role to assume
      Tags:
        Application: CustomerSupport

  RuntimeAgentcoreIAMRoleParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /app/redcross/agentcore/runtime_iam_role
      Type: String
      Value: !GetAtt RuntimeAgentCoreRole.Arn
      Description: agentcore IAM role to assume
      Tags:
        Application: CustomerSupport

  LambdaArnParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /app/redcross/agentcore/lambda_arn
      Type: String
      Value: !GetAtt CustomerSupportLambda.Arn
      Description: ARN of the lambda that integrates with agentcore
      Tags:
        Application: CustomerSupport

  # S3 Bucket for knowledge base documents
  BedrockKnowledgeBaseDataBucket:
    Type: AWS::S3::Bucket
    Properties:
      # Stack-scoped bucket name to avoid Early Validation conflicts
      BucketName: !Sub '${AWS::StackName}-kb-data-bucket'
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  # Lambda Layer with latest boto3
  Boto3Layer:
    Type: AWS::CloudFormation::CustomResource
    Properties:
      ServiceToken: !GetAtt Boto3LayerCreator.Arn

  Boto3LayerCreator:
    Type: AWS::Lambda::Function
    Properties:
      # Stack-scoped to avoid AWS::EarlyValidation::ResourceExistenceCheck on re-runs
      FunctionName: !Sub '${AWS::StackName}-kb-boto3-layer-creator'
      Runtime: python3.9
      Handler: index.handler
      Role: !GetAtt Boto3LayerCreatorRole.Arn
      Timeout: 900
      MemorySize: 1024
      Code:
        ZipFile: |
          import boto3
          import json
          import urllib.request
          import zipfile
          import tempfile
          import os
          import subprocess
          import sys
          
          def send_response(event, context, status, data=None, reason=None):
              # Minimal drop-in replacement for cfnresponse.send
              responseUrl = event['ResponseURL']
              responseBody = {
                  'Status': status,
                  'Reason': reason or f"See CloudWatch Log Stream: {getattr(context, 'log_stream_name', 'N/A')}",
                  'PhysicalResourceId': getattr(context, 'log_stream_name', 'INLINE_FUNCTION'),
                  'StackId': event['StackId'],
                  'RequestId': event['RequestId'],
                  'LogicalResourceId': event['LogicalResourceId'],
                  'NoEcho': False,
                  'Data': data or {}
              }
              dataBytes = json.dumps(responseBody).encode('utf-8')
              req = urllib.request.Request(responseUrl, data=dataBytes, method='PUT')
              req.add_header('content-type', '')
              req.add_header('content-length', str(len(dataBytes)))
              try:
                  with urllib.request.urlopen(req) as resp:
                      resp.read()
              except Exception as e:
                  print(f"send_response error: {e}")
                  
          def handler(event, context):
              try:
                  if event['RequestType'] == 'Delete':
                      send_response(event, context, 'SUCCESS', {})
                      return
                  
                  with tempfile.TemporaryDirectory() as temp_dir:
                      python_dir = os.path.join(temp_dir, 'python')
                      os.makedirs(python_dir)
                      
                      subprocess.check_call([
                          sys.executable, '-m', 'pip', 'install', 
                          'boto3>=1.34.0', 'botocore>=1.34.0',
                          '--target', python_dir, '--upgrade', '--no-cache-dir'
                      ])
                      
                      zip_path = os.path.join(temp_dir, 'boto3-layer.zip')
                      with zipfile.ZipFile(zip_path, 'w', zipfile.ZIP_DEFLATED) as zipf:
                          for root, dirs, files in os.walk(python_dir):
                              for file in files:
                                  if not file.startswith('.'):
                                      file_path = os.path.join(root, file)
                                      arcname = os.path.relpath(file_path, temp_dir)
                                      zipf.write(file_path, arcname)
                      
                      lambda_client = boto3.client('lambda')
                      with open(zip_path, 'rb') as f:
                          account_id = context.invoked_function_arn.split(':')[4]
                          region = context.invoked_function_arn.split(':')[3]
                          response = lambda_client.publish_layer_version(
                              LayerName=f"{account_id}-{region}-kb-boto3-layer",
                              Content={'ZipFile': f.read()},
                              CompatibleRuntimes=['python3.9', 'python3.10', 'python3.11'],
                              CompatibleArchitectures=['x86_64']
                          )
                      
                      send_response(event, context, 'SUCCESS', {
                          'LayerVersionArn': response['LayerVersionArn']
                      })
                      
              except Exception as e:
                  print(f"Error: {str(e)}")
                  send_response(event, context, 'FAILED', {}, reason=str(e))
                  
  Boto3LayerCreatorRole:
    Type: AWS::IAM::Role
    Properties:
      # Stack-scoped to avoid resource name conflicts
      RoleName: !Sub '${AWS::StackName}-kb-boto3-layer-creator-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: LayerCreatorPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - lambda:PublishLayerVersion
                  - lambda:DeleteLayerVersion
                Resource: '*'

  # IAM Role for Bedrock service
  BedrockServiceRole:
    Type: AWS::IAM::Role
    Properties:
      # Stack-scoped to avoid resource name conflicts
      RoleName: !Sub '${AWS::StackName}-kb-bedrock-service-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: bedrock.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: BedrockS3AccessPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:ListBucket
                Resource:
                  - !GetAtt BedrockKnowledgeBaseDataBucket.Arn
                  - !Sub '${BedrockKnowledgeBaseDataBucket.Arn}/*'
              - Effect: Allow
                Action:
                  - bedrock:InvokeModel
                Resource: !Sub 'arn:aws:bedrock:${AWS::Region}::foundation-model/amazon.titan-embed-text-v2:0'
              - Effect: Allow
                Action:
                  - s3vectors:ListIndexes
                  - s3vectors:ListVectorBuckets
                  - s3vectors:ListVectors
                  - s3vectors:ListIndexes
                  - s3vectors:GetVectorBucket
                  - s3vectors:GetVectors
                  - s3vectors:GetIndex
                  - s3vectors:PutVectorBucketPolicy
                  - s3vectors:PutVectors
                  - s3vectors:CreateVectorBucket
                  - s3vectors:CreateIndex
                  - s3vectors:QueryVectors
                  - s3vectors:GetVectorBucketPolicy
                Resource: '*'

  # Lambda function with technical documentation content
  KnowledgeBaseSetupFunction:
    Type: AWS::Lambda::Function
    Properties:
      # Stack-scoped to avoid AWS::EarlyValidation::ResourceExistenceCheck on re-runs
      FunctionName: !Sub '${AWS::StackName}-kb-setup-function'
      Runtime: python3.9
      Handler: index.lambda_handler
      Role: !GetAtt KnowledgeBaseSetupRole.Arn
      Timeout: 600
      MemorySize: 512
      Layers:
        - !GetAtt Boto3Layer.LayerVersionArn
      Code:
        ZipFile: |
          import boto3
          import json
          import urllib.request
          
          def send_response(event, context, status, data=None, reason=None):
              # Minimal drop-in replacement for cfnresponse.send
              responseUrl = event['ResponseURL']
              responseBody = {
                  'Status': status,
                  'Reason': reason or f"See CloudWatch Log Stream: {getattr(context, 'log_stream_name', 'N/A')}",
                  'PhysicalResourceId': getattr(context, 'log_stream_name', 'INLINE_FUNCTION'),
                  'StackId': event['StackId'],
                  'RequestId': event['RequestId'],
                  'LogicalResourceId': event['LogicalResourceId'],
                  'NoEcho': False,
                  'Data': data or {}
              }
              dataBytes = json.dumps(responseBody).encode('utf-8')
              req = urllib.request.Request(responseUrl, data=dataBytes, method='PUT')
              req.add_header('content-type', '')
              req.add_header('content-length', str(len(dataBytes)))
              try:
                  with urllib.request.urlopen(req) as resp:
                      resp.read()
              except Exception as e:
                  print(f"send_response error: {e}")
                  
          def lambda_handler(event, context):
              response_data = {
                  'Status': 'UNKNOWN',
                  'FilesUploaded': 0,
                  'S3Bucket': 'unknown',
                  'ParameterStoreCreated': 'NO',
                  'Error': 'No error'
              }
              
              try:
                  if event['RequestType'] == 'Delete':
                      response_data.update({
                          'Status': 'DELETED',
                          'Error': 'Stack deleted successfully'
                      })
                      send_response(event, context, 'SUCCESS', response_data)
                      return
                  
                  data_bucket_name = event['ResourceProperties']['BucketName']
                  execution_role_arn = event['ResourceProperties']['BedrockRoleArn']
                  response_data['S3Bucket'] = data_bucket_name
                  
                  print(f"Starting setup with bucket: {data_bucket_name}")
                  
                  # Create knowledge base content for three LOBs
                  # Biomedical Services
                  biomedical_docs = {}
                  biomedical_docs['biomedical/blood-drive-appointments.txt'] = """American Red Cross - Biomedical Services
                  Blood Drive Appointment Information
                  
                  EXISTING APPOINTMENTS DATABASE
                  
                  Appointment ID: BD-2024-001234
                  Donor Name: Sarah Johnson
                  Email: sarah.johnson@email.com
                  Phone: +1-555-0101
                  Appointment Date: March 15, 2024
                  Appointment Time: 10:00 AM
                  Location: Red Cross Center - Downtown Seattle
                  Address: 1234 Main Street, Seattle, WA 98101
                  Appointment Type: Whole Blood Donation
                  Status: Confirmed
                  Confirmation Code: ARC-BD-001234
                  Reminder Sent: Yes
                  Notes: First-time donor, completed pre-screening questionnaire
                  
                  Appointment ID: BD-2024-002456
                  Donor Name: Michael Chen
                  Email: michael.chen@email.com
                  Phone: +1-555-0102
                  Appointment Date: March 18, 2024
                  Appointment Time: 2:30 PM
                  Location: Community Center - Bellevue
                  Address: 5678 Park Avenue, Bellevue, WA 98004
                  Appointment Type: Power Red Donation
                  Status: Confirmed
                  Confirmation Code: ARC-BD-002456
                  Reminder Sent: Yes
                  Notes: Regular donor, last donation: January 18, 2024
                  
                  Appointment ID: BD-2024-003789
                  Donor Name: Emily Rodriguez
                  Email: emily.rodriguez@email.com
                  Phone: +1-555-0103
                  Appointment Date: March 20, 2024
                  Appointment Time: 11:00 AM
                  Location: Red Cross Mobile Unit - Tacoma
                  Address: 9012 Commerce Boulevard, Tacoma, WA 98402
                  Appointment Type: Whole Blood Donation
                  Status: Confirmed
                  Confirmation Code: ARC-BD-003789
                  Reminder Sent: Yes
                  Notes: Returning donor, eligible for double red cell donation
                  
                  FUTURE BLOOD DRIVE LOCATIONS AND SIGN-UP
                  
                  Upcoming Blood Drive - March 28, 2024
                  Location: Red Cross Center - Downtown Seattle
                  Address: 1234 Main Street, Seattle, WA 98101
                  Time: 8:00 AM - 6:00 PM
                  Available Slots: 45 remaining
                  Sign-Up: Online at redcross.org/blood or call 1-800-RED-CROSS
                  Appointment Types Available: Whole Blood, Power Red, Platelets
                  Parking: Free parking available in adjacent lot
                  Accessibility: Fully accessible, wheelchair accessible entrance
                  
                  Upcoming Blood Drive - March 30, 2024
                  Location: Community Center - Bellevue
                  Address: 5678 Park Avenue, Bellevue, WA 98004
                  Time: 9:00 AM - 5:00 PM
                  Available Slots: 32 remaining
                  Sign-Up: Online at redcross.org/blood or call 1-800-RED-CROSS
                  Appointment Types Available: Whole Blood, Power Red
                  Parking: Street parking and nearby parking garage
                  Accessibility: Ground floor access, accessible restrooms
                  
                  BLOOD DONATION ELIGIBILITY REQUIREMENTS
                  
                  Age Requirements: Must be at least 17 years old (16 with parental consent in some states)
                  Weight Requirements: Minimum 110 pounds for whole blood donation
                  Health Requirements: Generally good health, no active illness
                  Frequency: Whole blood every 56 days, Power Red every 112 days, Platelets every 7 days
                  Identification: Valid photo ID required at appointment
                  Pre-Donation: Complete health history questionnaire and mini-physical
                  
                  HOW TO SIGN UP FOR BLOOD DRIVE
                  
                  Online Registration:
                  1. Visit redcross.org/blood
                  2. Enter your zip code to find nearby drives
                  3. Select preferred date and time slot
                  4. Complete registration form
                  5. Receive confirmation email with appointment details
                  
                  Phone Registration:
                  Call 1-800-RED-CROSS (1-800-733-2767)
                  Available 24/7 for scheduling assistance
                  Have your preferred dates and locations ready
                  
                  CANCELLATION AND RESCHEDULING
                  
                  To Cancel: Log into your account at redcross.org/blood or call 1-800-RED-CROSS
                  Cancellation Policy: Cancel at least 24 hours in advance when possible
                  Rescheduling: Available online or by phone, subject to availability
                  No-Show Policy: Multiple no-shows may affect future appointment scheduling"""
                  
                  # Humanitarian Services
                  humanitarian_docs = {}
                  humanitarian_docs['humanitarian/relief-centers-grants.txt'] = """American Red Cross - Humanitarian Services
                  Relief Centers and Grant Application Information
                  
                  RELIEF CENTER LOCATIONS
                  
                  Relief Center - Seattle Metro
                  Address: 1234 Disaster Relief Way, Seattle, WA 98101
                  Phone: (206) 555-1001
                  Hours: Monday-Friday 8:00 AM - 6:00 PM, Saturday 9:00 AM - 4:00 PM
                  Services: Emergency shelter, food assistance, financial aid applications, case management
                  Accessibility: Fully accessible, multilingual staff available
                  Parking: Free parking available
                  Public Transit: Metro Bus lines 7, 14, 36, Link Light Rail - International District Station
                  
                  Relief Center - Tacoma
                  Address: 5678 Emergency Services Drive, Tacoma, WA 98402
                  Phone: (253) 555-2002
                  Hours: Monday-Friday 9:00 AM - 5:00 PM, Saturday 10:00 AM - 3:00 PM
                  Services: Emergency shelter, food assistance, financial aid applications, disaster recovery support
                  Accessibility: Ground floor access, wheelchair accessible
                  Parking: Street parking and nearby parking lot
                  Public Transit: Pierce Transit routes 1, 2, 3, Sound Transit Express
                  
                  GRANT APPLICATION DATABASE
                  
                  Grant Application ID: GR-2024-001234
                  Applicant Name: Maria Garcia
                  Email: maria.garcia@email.com
                  Phone: +1-555-0201
                  Application Date: February 15, 2024
                  Grant Type: Emergency Housing Assistance
                  Amount Requested: $2,500
                  Status: Approved
                  Approval Date: February 22, 2024
                  Disbursement Date: February 28, 2024
                  Disbursement Method: Direct deposit
                  Case Manager: John Smith
                  Case Manager Contact: (206) 555-1001 ext. 201
                  Notes: Approved for temporary housing assistance following house fire. Funds disbursed successfully.
                  
                  Grant Application ID: GR-2024-002456
                  Applicant Name: Robert Williams
                  Email: robert.williams@email.com
                  Phone: +1-555-0202
                  Application Date: February 20, 2024
                  Grant Type: Disaster Relief - Flood Damage
                  Amount Requested: $3,000
                  Status: Under Review
                  Review Start Date: February 25, 2024
                  Expected Decision Date: March 15, 2024
                  Case Manager: Sarah Johnson
                  Case Manager Contact: (253) 555-2002 ext. 302
                  Notes: Application submitted with required documentation. Property damage assessment in progress.
                  
                  HOW TO APPLY FOR AID GRANTS
                  
                  Step 1: Determine Eligibility
                  - Must demonstrate financial need
                  - Must have experienced qualifying emergency or disaster
                  - Must provide required documentation
                  - Must be resident of service area
                  
                  Step 2: Gather Required Documents
                  - Proof of identity (government-issued ID)
                  - Proof of income (pay stubs, tax returns, benefit statements)
                  - Proof of emergency/disaster (photos, reports, insurance claims)
                  - Proof of expenses (bills, receipts, estimates)
                  - Bank statements (last 3 months)
                  
                  Step 3: Submit Application
                  Online Application:
                  - Visit redcross.org/apply-for-aid
                  - Create account or log in
                  - Complete application form
                  - Upload required documents
                  - Submit application
                  - Receive confirmation email with application ID
                  
                  GRANT APPLICATION STATUS CHECK
                  
                  To check your application status:
                  1. Visit redcross.org/application-status
                  2. Enter your Application ID (format: GR-YYYY-XXXXXX)
                  3. Enter your email address or phone number
                  4. View current status and next steps
                  
                  Or call your assigned case manager using the contact information provided in your confirmation email."""
                  
                  # Training Services
                  training_docs = {}
                  training_docs['training/first-aid-classes-registrations.txt'] = """American Red Cross - Training Services
                  First Aid Training Classes, Schedules, and Registration Information
                  
                  UPCOMING FIRST AID TRAINING CLASSES
                  
                  Class ID: FA-2024-001
                  Course Name: Adult and Pediatric First Aid/CPR/AED
                  Date: March 25, 2024
                  Time: 9:00 AM - 5:00 PM
                  Location: Red Cross Training Center - Seattle
                  Address: 1234 Training Way, Seattle, WA 98101
                  Instructor: Jennifer Martinez
                  Available Seats: 8 remaining (class capacity: 20)
                  Cost: $95.00
                  Certification: Valid for 2 years
                  Registration Deadline: March 22, 2024
                  Prerequisites: None
                  Materials Included: Student manual, certification card
                  Parking: Free parking available
                  Accessibility: Fully accessible, sign language interpreter available upon request
                  
                  Class ID: FA-2024-002
                  Course Name: Basic Life Support (BLS) for Healthcare Providers
                  Date: March 27, 2024
                  Time: 8:00 AM - 12:00 PM
                  Location: Community Health Center - Bellevue
                  Address: 5678 Health Education Drive, Bellevue, WA 98004
                  Instructor: Michael Chen
                  Available Seats: 5 remaining (class capacity: 12)
                  Cost: $120.00
                  Certification: Valid for 2 years
                  Registration Deadline: March 24, 2024
                  Prerequisites: Healthcare provider or student in healthcare field
                  Materials Included: BLS manual, certification card, pocket mask
                  Parking: Street parking available
                  Accessibility: Ground floor access
                  
                  REGISTERED STUDENT ACCOUNTS
                  
                  Student Account ID: ST-2024-001234
                  Student Name: Robert Williams
                  Email: robert.williams@email.com
                  Phone: +1-555-0301
                  Registered Classes:
                  - Class FA-2024-001: Adult and Pediatric First Aid/CPR/AED (March 25, 2024) - Confirmed
                  Account Status: Active
                  Certifications Held: None (new student)
                  Payment Status: Paid in full
                  Reminder Sent: Yes
                  Account Notes: Registered for class, first-time student
                  
                  Student Account ID: ST-2024-002456
                  Student Name: Lisa Anderson
                  Email: lisa.anderson@email.com
                  Phone: +1-555-0302
                  Registered Classes:
                  - Class FA-2024-002: Basic Life Support (BLS) for Healthcare Providers (March 27, 2024) - Confirmed
                  Account Status: Active
                  Certifications Held: Adult and Pediatric First Aid/CPR/AED (expires: June 15, 2024)
                  Payment Status: Paid in full
                  Reminder Sent: Yes
                  Account Notes: Healthcare professional, renewing BLS certification
                  
                  HOW TO REGISTER FOR TRAINING CLASSES
                  
                  Online Registration:
                  1. Visit redcross.org/take-a-class
                  2. Search for course by name, location, or date
                  3. Select desired class from available options
                  4. Create account or log in to existing account
                  5. Complete registration form
                  6. Make payment online (credit card, debit card, PayPal)
                  7. Receive confirmation email with class details and student account information
                  8. Access student portal for class materials and updates
                  
                  STUDENT ACCOUNT INFORMATION
                  
                  Accessing Your Account:
                  - Visit redcross.org/my-account
                  - Log in with email and password
                  - View registered classes, certifications, and account history
                  - Download certificates, update contact information
                  - Register for additional classes
                  
                  Account Features:
                  - View upcoming class schedules and locations
                  - Access digital course materials (for eligible classes)
                  - Download certification cards
                  - View certification expiration dates
                  - Update contact information
                  - View payment history"""
                  
                  # Upload all three knowledge base files
                  s3_client = boto3.client('s3')
                  uploaded_count = 0
                  
                  all_docs = {**biomedical_docs, **humanitarian_docs, **training_docs}
                  
                  for filename, content in all_docs.items():
                      try:
                          print(f"Uploading {filename}...")
                          # Remove YAML block-indent spaces (18) added so multi-line strings parse correctly
                          normalized = '\n'.join(l.strip() for l in content.split('\n')).strip()
                          s3_client.put_object(
                              Bucket=data_bucket_name,
                              Key=filename,
                              Body=normalized.encode('utf-8'),
                              ContentType='text/plain'
                          )
                          uploaded_count += 1
                          print(f"Successfully uploaded {filename}")
                      except Exception as e:
                          print(f"Failed to upload {filename}: {str(e)}")
                  
                  response_data['FilesUploaded'] = uploaded_count
                  
                  if uploaded_count == 0:
                      response_data.update({
                          'Status': 'FAILED',
                          'Error': 'No knowledge base files were uploaded successfully'
                      })
                      send_response(event, context, 'SUCCESS', response_data)
                      return
                  
                  try:
                      s3vectors = boto3.client('s3vectors')
                      bedrock = boto3.client('bedrock-agent')
                  except Exception as e:
                      response_data.update({
                          'Status': 'FAILED',
                          'Error': f'Client initialization failed: {str(e)}'
                      })
                      send_response(event, context, 'SUCCESS', response_data)
                      return
                  
                  account_id = context.invoked_function_arn.split(':')[4]
                  region = context.invoked_function_arn.split(':')[3]
                  
                  # Define the three LOBs
                  lobs = ['biomedical', 'humanitarian', 'training']
                  kb_results = {}
                  
                  # Create knowledge base for each LOB
                  for lob_name in lobs:
                      try:
                          print(f"\n{'='*60}")
                          print(f"Creating {lob_name.upper()} knowledge base")
                          print(f"{'='*60}")
                          
                          vector_bucket_name = f"{account_id}-{region}-kb-{lob_name}-vector-bucket"
                          index_name = f"{account_id}-{region}-kb-{lob_name}-vector-index"
                          kb_name = f"{account_id}-{region}-kb-{lob_name}"
                          datasource_name = f"{account_id}-{region}-kb-{lob_name}-datasource"
                          
                          # Create vector bucket
                          print(f"Creating S3 vector bucket: {vector_bucket_name}")
                          try:
                              s3vectors.create_vector_bucket(
                                  vectorBucketName=vector_bucket_name,
                                  encryptionConfiguration={'sseType': 'AES256'}
                              )
                              print(f" Created vector bucket: {vector_bucket_name}")
                          except Exception as e:
                              if 'Conflict' in str(e) or 'already exists' in str(e).lower():
                                  print(f"  Vector bucket already exists: {vector_bucket_name}")
                              else:
                                  raise
                          
                          # Create vector index
                          print(f"Creating vector index: {index_name}")
                          try:
                              s3vectors.create_index(
                                  vectorBucketName=vector_bucket_name,
                                  indexName=index_name,
                                  dimension=1024,
                                  distanceMetric='cosine',
                                  dataType='float32'
                              )
                              print(f" Created vector index: {index_name}")
                          except Exception as e:
                              if 'Conflict' in str(e) or 'already exists' in str(e).lower():
                                  print(f"  Vector index already exists: {index_name}")
                              else:
                                  raise
                          
                          index_arn = f"arn:aws:s3vectors:{region}:{account_id}:bucket/{vector_bucket_name}/index/{index_name}"
                          
                          # Create knowledge base
                          print(f"Creating knowledge base: {kb_name}")
                          try:
                              kb_response = bedrock.create_knowledge_base(
                                  name=kb_name,
                                  roleArn=execution_role_arn,
                                  knowledgeBaseConfiguration={
                                      'type': 'VECTOR',
                                      'vectorKnowledgeBaseConfiguration': {
                                          'embeddingModelArn': f'arn:aws:bedrock:{region}::foundation-model/amazon.titan-embed-text-v2:0',
                                          'embeddingModelConfiguration': {
                                              'bedrockEmbeddingModelConfiguration': {
                                                  'dimensions': 1024,
                                                  'embeddingDataType': 'FLOAT32'
                                              }
                                          }
                                      }
                                  },
                                  storageConfiguration={
                                      'type': 'S3_VECTORS',
                                      's3VectorsConfiguration': {
                                          'indexArn': index_arn
                                      }
                                  }
                              )
                              kb_id = kb_response['knowledgeBase']['knowledgeBaseId']
                              print(f" Created knowledge base: {kb_id}")
                          except bedrock.exceptions.ConflictException:
                              # Knowledge base already exists, get its ID
                              print(f"  Knowledge base already exists, retrieving ID...")
                              kb_list = bedrock.list_knowledge_bases()
                              for kb in kb_list['knowledgeBaseSummaries']:
                                  if kb['name'] == kb_name:
                                      kb_id = kb['knowledgeBaseId']
                                      print(f" Found existing knowledge base: {kb_id}")
                                      break
                              else:
                                  raise Exception(f"Could not find knowledge base: {kb_name}")
                          
                          # Create data source
                          print(f"Creating data source: {datasource_name}")
                          try:
                              ds_response = bedrock.create_data_source(
                                  knowledgeBaseId=kb_id,
                                  name=datasource_name,
                                  dataSourceConfiguration={
                                      'type': 'S3',
                                      's3Configuration': {
                                          'bucketArn': f"arn:aws:s3:::{data_bucket_name}",
                                          'inclusionPrefixes': [f"{lob_name}/"]
                                      }
                                  },
                                  vectorIngestionConfiguration={
                                      'chunkingConfiguration': {
                                          'chunkingStrategy': 'FIXED_SIZE',
                                          'fixedSizeChunkingConfiguration': {
                                              'maxTokens': 200,
                                              'overlapPercentage': 10
                                          }
                                      }
                                  }
                              )
                              ds_id = ds_response['dataSource']['dataSourceId']
                              print(f" Created data source: {ds_id}")
                          except bedrock.exceptions.ConflictException:
                              # Data source already exists
                              print(f"  Data source already exists: {datasource_name}")
                              ds_list = bedrock.list_data_sources(knowledgeBaseId=kb_id)
                              for ds in ds_list['dataSourceSummaries']:
                                  if ds['name'] == datasource_name:
                                      ds_id = ds['dataSourceId']
                                      print(f" Found existing data source: {ds_id}")
                                      break
                              else:
                                  raise Exception(f"Could not find data source: {datasource_name}")
                          
                          # Trigger ingestion job
                          print(f"Starting ingestion job for {lob_name} knowledge base...")
                          try:
                              ingestion_response = bedrock.start_ingestion_job(
                                  knowledgeBaseId=kb_id,
                                  dataSourceId=ds_id,
                                  description=f"Initial sync for {lob_name} knowledge base"
                              )
                              ingestion_job_id = ingestion_response['ingestionJob']['ingestionJobId']
                              print(f" Started ingestion job: {ingestion_job_id}")
                          except Exception as ingestion_error:
                              print(f"  Could not start ingestion job automatically: {str(ingestion_error)}")
                              print(f"   You may need to trigger it manually from the Bedrock console")
                          
                          # Store results
                          kb_results[lob_name] = {
                              'kb_id': kb_id,
                              'ds_id': ds_id,
                              'vector_bucket_name': vector_bucket_name,
                              'index_name': index_name,
                              'kb_name': kb_name,
                              'datasource_name': datasource_name
                          }
                          
                          print(f" Successfully set up {lob_name} knowledge base")
                          
                      except Exception as e:
                          print(f" Failed to set up {lob_name} knowledge base: {str(e)}")
                          kb_results[lob_name] = {'error': str(e)}
                  
                  # Store all KB IDs in Parameter Store
                  print("\nCreating Parameter Store entries...")
                  ssm_client = boto3.client('ssm')
                  ssm_success_count = 0
                  
                  for lob_name, result in kb_results.items():
                      if 'error' not in result:
                          try:
                              ssm_client.put_parameter(
                                  Name=f"/{account_id}-{region}/kb/{lob_name}/knowledge-base-id",
                                  Value=result['kb_id'],
                                  Type='String',
                                  Description=f'American Red Cross {lob_name.title()} Knowledge Base ID',
                                  Overwrite=True
                              )
                              
                              ssm_client.put_parameter(
                                  Name=f"/{account_id}-{region}/kb/{lob_name}/data-source-id",
                                  Value=result['ds_id'],
                                  Type='String',
                                  Description=f'American Red Cross {lob_name.title()} Data Source ID',
                                  Overwrite=True
                              )
                              
                              ssm_success_count += 1
                              print(f" Stored {lob_name} KB parameters")
                          except Exception as ssm_error:
                              print(f"  Failed to store {lob_name} parameters: {str(ssm_error)}")
                  
                  # Update response data
                  if ssm_success_count == len([r for r in kb_results.values() if 'error' not in r]):
                      response_data.update({
                          'Status': 'SUCCESS',
                          'ParameterStoreCreated': 'YES',
                          'Error': 'All three Red Cross knowledge bases created successfully'
                      })
                  else:
                      response_data.update({
                          'Status': 'PARTIAL_SUCCESS',
                          'ParameterStoreCreated': f'{ssm_success_count}/{len(kb_results)} LOBs',
                          'Error': f'Some knowledge bases may not have been fully configured'
                      })
                  
                  print("\n Red Cross knowledge base setup completed!")
                  send_response(event, context, 'SUCCESS', response_data)
                      
              except Exception as e:
                  print(f"Critical error: {str(e)}")
                  response_data.update({
                      'Status': 'FAILED',
                      'Error': f"Critical error: {str(e)}"
                  })
                  send_response(event, context, 'SUCCESS', response_data)
                  
  KnowledgeBaseSetupRole:
    Type: AWS::IAM::Role
    Properties:
      # Stack-scoped to avoid resource name conflicts
      RoleName: !Sub '${AWS::StackName}-kb-setup-function-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: KnowledgeBaseSetupPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:PutObject
                  - s3:PutObjectAcl
                  - s3:ListBucket
                Resource:
                  - !GetAtt BedrockKnowledgeBaseDataBucket.Arn
                  - !Sub '${BedrockKnowledgeBaseDataBucket.Arn}/*'
              - Effect: Allow
                Action:
                  - s3vectors:CreateVectorBucket
                  - s3vectors:CreateIndex
                  - s3vectors:GetVectorBucket
                  - s3vectors:GetIndex
                Resource: '*'
              - Effect: Allow
                Action:
                  - bedrock:CreateKnowledgeBase
                  - bedrock:CreateDataSource
                  - bedrock:StartIngestionJob
                  - bedrock:ListKnowledgeBases
                  - bedrock:ListDataSources
                Resource: '*'
              - Effect: Allow
                Action:
                  - iam:PassRole
                Resource: !GetAtt BedrockServiceRole.Arn
              - Effect: Allow
                Action:
                  - ssm:PutParameter
                  - ssm:GetParameter
                Resource: !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/*'

  # Trigger the setup (ConfigVersion forces Custom Resource to re-run on stack update)
  KnowledgeBaseSetup:
    Type: AWS::CloudFormation::CustomResource
    Properties:
      ServiceToken: !GetAtt KnowledgeBaseSetupFunction.Arn
      BucketName: !Ref BedrockKnowledgeBaseDataBucket
      BedrockRoleArn: !GetAtt BedrockServiceRole.Arn
      ConfigVersion: "2"

Outputs:
  S3DataBucketName:
    Description: 'S3 bucket containing Red Cross knowledge base data'
    Value: !Ref BedrockKnowledgeBaseDataBucket

  SetupStatus:
    Description: 'Setup completion status'
    Value: !GetAtt KnowledgeBaseSetup.Status

  FilesUploaded:
    Description: 'Number of knowledge base files uploaded'
    Value: !GetAtt KnowledgeBaseSetup.FilesUploaded

  ParameterStoreCreated:
    Description: 'Whether Parameter Store parameters were created'
    Value: !GetAtt KnowledgeBaseSetup.ParameterStoreCreated

  ParameterStoreBiomedicalKB:
    Description: 'Parameter Store path for Biomedical Knowledge Base ID'
    Value: !Sub '${AWS::AccountId}-${AWS::Region}/kb/biomedical/knowledge-base-id'

  ParameterStoreHumanitarianKB:
    Description: 'Parameter Store path for Humanitarian Knowledge Base ID'
    Value: !Sub '${AWS::AccountId}-${AWS::Region}/kb/humanitarian/knowledge-base-id'

  ParameterStoreTrainingKB:
    Description: 'Parameter Store path for Training Services Knowledge Base ID'
    Value: !Sub '${AWS::AccountId}-${AWS::Region}/kb/training/knowledge-base-id'

  ErrorMessage:
    Description: 'Error message or success confirmation'
    Value: !GetAtt KnowledgeBaseSetup.Error